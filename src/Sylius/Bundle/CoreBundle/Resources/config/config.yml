# This file is part of the Sylius package.
# (c) Paweł Jędrzejewski

imports:
    - { resource: "@SyliusAddressingBundle/Resources/config/config.yml" }
    - { resource: "@SyliusAttributeBundle/Resources/config/config.yml" }
    - { resource: "@SyliusChannelBundle/Resources/config/config.yml" }
    - { resource: "@SyliusContactBundle/Resources/config/config.yml" }
    - { resource: "@SyliusContentBundle/Resources/config/config.yml" }
    - { resource: "@SyliusCurrencyBundle/Resources/config/config.yml" }
    - { resource: "@SyliusInventoryBundle/Resources/config/config.yml" }
    - { resource: "@SyliusLocaleBundle/Resources/config/config.yml" }
    - { resource: "@SyliusOrderBundle/Resources/config/config.yml" }
    - { resource: "@SyliusPaymentBundle/Resources/config/config.yml" }
    - { resource: "@SyliusProductBundle/Resources/config/config.yml" }
    - { resource: "@SyliusPromotionBundle/Resources/config/config.yml" }
    - { resource: "@SyliusResourceBundle/Resources/config/config.yml" }
    - { resource: "@SyliusShippingBundle/Resources/config/config.yml" }
    - { resource: "@SyliusTaxationBundle/Resources/config/config.yml" }
    - { resource: "@SyliusTaxonomyBundle/Resources/config/config.yml" }
    - { resource: "@SyliusUserBundle/Resources/config/config.yml" }
    - { resource: "@SyliusVariationBundle/Resources/config/config.yml" }

    - { resource: "sylius.yml" }

assetic:
    debug: "%kernel.debug%"
    use_controller: false
    filters:
        cssrewrite: ~

doctrine:
    orm:
        auto_generate_proxy_classes: "%kernel.debug%"
        entity_managers:
            default:
                auto_mapping: true
                mappings:
                    gedmo_loggable:
                        type: annotation
                        prefix: Gedmo\Loggable\Entity
                        dir: "%kernel.root_dir%/../vendor/gedmo/doctrine-extensions/lib/Gedmo/Loggable/Entity"
                        is_bundle: false

doctrine_cache:
    providers:
        sylius_settings: "%sylius.cache%"
        sylius_rbac: "%sylius.cache%"

doctrine_migrations:
    dir_name: "@SyliusCoreBundle/Migrations"
    namespace: Sylius\Bundle\CoreBundle\Migrations
    table_name: sylius_migrations
    name: Sylius Migrations

doctrine_phpcr:
    session:
        backend:
            type: doctrinedbal
            connection: default
            caches:
                meta: doctrine_cache.providers.phpcr_meta
                nodes: doctrine_cache.providers.phpcr_nodes
        workspace: default
    odm:
        auto_mapping: true
        auto_generate_proxy_classes: "%kernel.debug%"

jms_serializer:
    metadata:
        directories:
            sylius-core:
                namespace_prefix: "Sylius\\Component\\Core"
                path: "@SyliusCoreBundle/Resources/config/serializer"

knp_gaufrette:
    adapters:
        sylius_image:
            local:
                directory: "%kernel.root_dir%/../web/media/image"
                create: true
    filesystems:
        sylius_image:
            adapter: "%sylius.uploader.filesystem%"

knp_snappy:
    pdf:
        enabled: true
        binary: "%wkhtmltopdf.bin_path%"
        options: []
    image:
        enabled: true
        binary: "%wkhtmltoimage.bin_path%"
        options: []

liip_imagine:
    loaders:
        default:
            filesystem:
                data_root: "%kernel.root_dir%/../web/media/image"
    filter_sets:
        sylius_small:
            filters:
                thumbnail: { size: [120, 90], mode: outbound }
        sylius_medium:
            filters:
                thumbnail: { size: [240, 180], mode: outbound }
        sylius_large:
            filters:
                thumbnail: { size: [640, 480], mode: outbound }

payum:
    storages:
        "%sylius.model.order.class%": { doctrine: orm }
        "%sylius.model.payment.class%": { doctrine: orm }

    security:
        token_storage:
            Sylius\Bundle\PayumBundle\Model\PaymentSecurityToken: { doctrine: orm }

    dynamic_gateways:
        config_storage:
            Sylius\Bundle\PayumBundle\Model\GatewayConfig: { doctrine: orm }

    gateways:
        offline:
            offline: ~
        cash_on_delivery:
            offline: ~

sonata_block:
    default_contexts: [cms]
    blocks:
        sonata.block.service.text: ~

stof_doctrine_extensions:
    default_locale: "%locale%"
    orm:
        default:
            tree: true
            sluggable: true
            timestampable: true
            loggable: true
            sortable: true

twig:
    debug: "%kernel.debug%"
    strict_variables: "%kernel.debug%"
    exception_controller: "FOS\\RestBundle\\Controller\\ExceptionController::showAction"

winzou_state_machine:
    sylius_order_checkout:
        class: "%sylius.model.order.class%"
        property_path: checkoutState
        graph: sylius_order_checkout
        state_machine_class: "%sylius.state_machine.class%"
        states:
            cart: ~
            addressed: ~
            shipping_selected: ~
            payment_selected: ~
            completed: ~
        transitions:
            address:
                from: [cart]
                to: addressed
            readdress:
                from: [payment_selected, shipping_selected, addressed]
                to: cart
            select_shipping:
                from: [addressed]
                to: shipping_selected
            reselect_shipping:
                from: [payment_selected, shipping_selected]
                to: addressed
            select_payment:
                from: [shipping_selected]
                to: payment_selected
            reselect_payment:
                from: [payment_selected]
                to: shipping_selected
            complete:
                from: [payment_selected]
                to: completed
        callbacks:
            after:
                recalculate_order:
                    on: ["address", "readdress", "select_shipping", "reselect_shipping", "select_payment", "reselect_payment"]
                    do: ["@sylius.order_processing.order_recalculator", "recalculate"]
                    args: ["object"]

    sylius_order_shipping:
        class: "%sylius.model.order.class%"
        property_path: shippingState
        graph: sylius_order_shipping
        state_machine_class: "%sylius.state_machine.class%"
        states:
            checkout: ~
            onhold: ~
            ready: ~
            backordered: ~
            partially_shipped: ~
            shipped: ~
            cancelled: ~
            returned: ~
        transitions:
            hold:
                from: [checkout]
                to: onhold
            create:
                from: [checkout, onhold]
                to: ready
            ship:
                from: [ready, partially_shipped]
                to: shipped
            ship_partially:
                from: [ready, partially_shipped]
                to: partially_shipped
            return:
                from: [partially_shipped, shipped]
                to: returned
            cancel:
                from: [checkout, onhold, ready, backordered]
                to: cancelled

    sylius_order_payment:
        class: "%sylius.model.order.class%"
        property_path: paymentState
        graph: sylius_order_payment
        state_machine_class: "%sylius.state_machine.class%"
        states:
            new: ~
            pending: ~
            processing: ~
            completed: ~
            void: ~
            failed: ~
            cancelled: ~
            refunded: ~
        transitions:
            create:
                from: [new]
                to: pending
            process:
                from: [new, pending]
                to: processing
            complete:
                from: [pending, processing]
                to: completed
            fail:
                from: [pending, processing]
                to: failed
            cancel:
                from: [new, pending, processing]
                to: cancelled
            refund:
                from: [completed]
                to: refunded

    sylius_payment:
        callbacks:
            after:
                sylius_update_order:
                    on: "complete"
                    do: ["@sylius.callback.order_payment", "updateOrderOnPayment"]
                    args: ["object"]

    sylius_order:
        callbacks:
            after:
                sylius_update_inventory:
                    on: "confirm"
                    do: ["@sylius.order_processing.inventory_handler", "updateInventory"]
                    args: ["object"]
                sylius_update_shipment:
                    on: "confirm"
                    do: ["@sylius.callback.shipment_states", "updateOrderShipmentStates"]
                    args: ["object"]
                sylius_increment_coupon:
                    on: "confirm"
                    do: ["@sylius.callback.coupon_usage", "incrementCouponUsage"]
                    args: ["object"]
                sylius_order_confirmation_email:
                    on: ["confirm"]
                    do: ["@sylius.email_manager.order", "sendConfirmationEmail"]
                    args: ["object"]
                sylius_release_inventory:
                    on: "release"
                    do: ["@sylius.order_processing.inventory_handler", "releaseInventory"]
                    args: ["object"]
                sylius_release_shipment:
                    on: "release"
                    do: ["@sm.callback.cascade_transition", "apply"]
                    args: ["object.getShipments()", "event", "'release'", "'sylius_shipment'"]
                sylius_void_payment:
                    on: "release"
                    do: ["@sm.callback.cascade_transition", "apply"]
                    args: ["object.getPayments()", "event", "'void'", "'sylius_payment'"]
                sylius_increment_sold_variants:
                    on: "confirm"
                    do: ["@sylius.callback.complete_order", "increaseSoldVariants"]
                    args: ["object"]
                sylius_decrement_sold_variants:
                    on: "cancel"
                    do: ["@sylius.callback.complete_order", "decreaseSoldVariants"]
                    args: ["object"]
                sylius_increment_promotion:
                    on: "create"
                    do: ["@sylius.callback.promotion_usage", "incrementPromotionUsage"]
                    args: ["object"]
                sylius_decrement_promotion:
                    on: ["release", "abandon"]
                    do: ["@sylius.callback.promotion_usage", "decrementPromotionUsage"]
                    args: ["object"]

    sylius_inventory_unit:
        callbacks:
            after:
                sylius_sync_shipping:
                    excluded_to: [sold]
                    do: ["@sm.callback.cascade_transition", "apply"]
                    args: ["object", "event", "null", "'sylius_shipment_unit'"]

    sylius_shipment:
        callbacks:
            after:
                sylius_sync_order_ship:
                    to: "shipped"
                    do: ["@sylius.callback.order_shipment", "updateOrderShippingState"]
                    args: ["object.getOrder()"]
                sylius_shipping_confirmation_email:
                    to: "shipped"
                    do: ["@sylius.email_manager.shipment", "sendConfirmationEmail"]
                    args: ["object"]

    sylius_review:
        class: "%sylius.model.product_review.class%"
        property_path: status
        graph: sylius_product_review
        state_machine_class: Sylius\Component\Resource\StateMachine\StateMachine
        states:
            new: ~
            accepted: ~
            rejected: ~
        transitions:
            accept:
                from: [new]
                to: accepted
            reject:
                from: [new]
                to: rejected
        callbacks:
            after:
                update_price:
                    on: "accept"
                    do: ["@sylius.review.updater.average_rating", updateFromReview]
                    args: ["object"]
